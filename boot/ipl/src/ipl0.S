# **** 機能
# FDからIPL以降の内容をメモリに読み込み、実行する


# **** ディスク読み込み時の注意
# (このプログラムの場合は1セクタずつ読み込んでいるので気にしなくてよい)
#
# ・複数のトラックに、またがって読み込めない
#
# ・64KB境界をまたごうとするとエラーになる(エラーコード %AH=0x09)
# つまり0x10000, 0x20000, ... をまたいで読み込めない

    .code16gcc
    .text

    jmp   entry

    # FAT12

    .byte   0x90
    .ascii  "ONSEN   "        # ブートセクタの名前(8バイト)
    .word   512               # 1セクタの大きさ
    .byte   1                 # クラスタの大きさ
    .word   1                 # FATがどこから始まるか
    .byte   2                 # FATの個数
    .word   224               # ルートディレクトリのサイズ
    .word   2880              # このドライブの大きさ
    .byte   0xF0              # メディアのタイプ
    .word   9                 # FAT領域の長さ
    .word   18                # 1トラックにいくつのセクタがあるか
    .word   2                 # ヘッドの数
    .int    0                 # 必ず0
    .int    2880              # ドライブのサイズ
    .byte   0, 0, 0x29
    .int    0xFFFFFFFF        # ボリュームシリアル番号
    .ascii  "ONSEN      "     # ディスクの名前(11バイト)
    .ascii  "FAT12   "        # フォーマットの名前
    .skip   18, 0x00          # とりあえず18バイト空けておく

entry:
    # レジスタ初期化
    movw  $0, %ax
    movw  %ax, %ss
    movw  $0x7C00, %sp
    movw  %ax, %ds


    # フロッピーディスクからデータを読み込む
    call load_fd


    # メモリへ読み込んだバイナリを実行
    # セグメントベースをオフセットに変換してジャンプ
    # 0x8000 + 0x4200 (FD読み込み先メモリ + FD(FAT12)のファイル格納位置)
    jmp   0xC200
